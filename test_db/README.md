# Задание по выбору хранилища

В качестве кандидатов для выбора хранилища для обработки аналитических данных были выбраны ClickHouse и Vertica. 
Были преприняты так же попытки протестировать CassandraDB, однако уже на 2млн записей Cassandra отказывалась исполнять какие-либо запросы на чтение за разумное время. По этой причине в тестах она не участвовала.

Условия тестов:
Ресурсы контейнера для БД - 4гб оперативной памяти, 4 CPU,
до начала тестов в контейнер помещались 10млн записей, по 1000 уникальных UUID для пользователей и фильмов

Описания тестов:
- `select_average_timestamps` - достать `id` всех фильмов со средним временем их просмотра
- `select_max_timestamp_by_user_movie` - достать timestamp, на котором остановился пользователь при просмотре фильма
- `select_max_timestamps_by_user` - достать timestamp-ы, на которых остановился пользователь для всех фильмов
- `select_movies_by_user` - достать id фильмов, которые просматривал пользователь
- `select_users_by_movie` - достать id пользователей, которые просматривали фильм
- `insert_batch_{batch_size}` - вставка батча

Описания схем и запросов доступны в папках с тестами соответствующих баз.

Для тестирования запросов под нагрузкой запускался дополнительный процесс, генерирующий 100 запросов на вставку в секунду.
Размер батча для ClickHouse - 100 записей. Для нагрузки в 200 рпс запускался еще один такой процесс. 
Для Vertica из-за низкой скорости вставки, записи в нагрузке вставлялись по одной.

## Результаты тестов
### ClickHouse
| Тест | Без нагрузки, мс | 100 RPS, мс | 200 RPS, мс |
|---|:---:|:---:|:---:|
| `select_average_timestamps` | 98.02+-31.12 | 123.54+-28.84 | 228.42+-121.72 |
| `select_max_timestamp_by_user_movie` | 9.18+-9.32 | 9.07+-6.02 | 11.99+-6.08 |
| `select_max_timestamps_by_user` | 8.06+-6.65 | 7.78+-1.92 | 19.91+-26.86 |
| `select_movies_by_user` | 8.49+-8.80 | 11.47+-8.81 | 11.83+-4.81 |
| `select_users_by_movie` | 98.43+-40.43 | 93.88+-19.81 | 192.25+-46.38 |
| `insert_batch_1` | 5.56+-2.05 | 5.54+-1.86 | 12.51+-10.29 |
| `insert_batch_100` | 5.99+-1.76 | 6.46+-2.45 | 8.73+-4.54 |
| `insert_batch_1000` | 11.43+-2.16 | 12.95+-9.67 | 17.55+-8.20 |

### Vertica
| Тест | Без нагрузки, мс | 100 RPS, мс | 200 RPS, мс |
|---|:---:|:---:|:---:|
| `select_average_timestamps` | 359.26+-77.51 | 450.14+-101.27 | 525.49+-167.98 |
| `select_max_timestamp_by_user_movie` | 40.67+-22.33 | 57.86+-27.65 | 81.93+-23.15 |
| `select_max_timestamps_by_user` | 61.74+-28.09  | 75.33+-23.16 | 101.25+-33.47 |
| `select_movies_by_user` | 55.02+-45.89 | 63.57+-33.12 | 84.16+-38.16 |
| `select_users_by_movie` | 176.06+-17.47 | 215.86+-35.16 | 248.61+-53.16 |
| `insert_batch_1` | 15.49+-8.85 | 16.11+-8.11 | 26.17+-11.23 |
| `insert_batch_100` | 839.55+-320.43 | 897+-319.18 | 965.37+-387.84 |
| `insert_batch_1000` | 8208.69+-1390.00 | 8265.92+-1187.21 | 8306.98+-1374.16 |

Как видно по данным, при схожих параметрах, в запросах на получение данных Vertica обгоняет Clickhouse в разы, а на вставку на порядки.
По этим причинам для дальнейшей работы в качестве аналитической базы данных был выбран Clickhouse.
