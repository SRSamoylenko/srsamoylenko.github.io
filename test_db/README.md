# Задание по выбору хранилища

В качестве кандидатов для выбора хранилища для обработки аналитических данных были выбраны ClickHouse и Vertica. 
Были преприняты так же попытки протестировать CassandraDB, однако уже на 2млн записей Cassandra отказывалась исполнять какие-либо запросы на чтение за разумное время. По этой причине в тестах она не участвовала.

Условия тестов:
Ресурсы контейнера для БД - 4гб оперативной памяти, 4 CPU,
до начала тестов в контейнер помещались 10млн записей, по 1000 уникальных UUID для пользователей и фильмов

Описания тестов:
- `select_average_timestamps` - достать `id` всех фильмов со средним временем их просмотра
- `select_max_timestamp_by_user_movie` - достать timestamp, на котором остановился пользователь при просмотре фильма
- `select_max_timestamps_by_user` - достать timestamp-ы, на которых остановился пользователь для всех фильмов
- `select_movies_by_user` - достать id фильмов, которые просматривал пользователь
- `select_users_by_movie` - достать id пользователей, которые просматривали фильм
- `insert_batch_{batch_size}` - вставка батча

Описания схем и запросов доступны в папках с тестами соответствующих баз.

Для тестирования запросов под нагрузкой запускался дополнительный процесс, генерирующий 100 запросов на вставку в секунду.
Размер батча для ClickHouse - 100 записей. Для нагрузки в 200 рпс запускался еще один такой процесс.

## Результаты тестов
### ClickHouse
| Тест | Без нагрузки, мс | 100 RPS, мс | 200 RPS, мс |
|---|:---:|:---:|:---:|
| `select_average_timestamps` | 98.02+-31.12 | 123.54+-28.84 | 228.42+-121.72 |
| `select_max_timestamp_by_user_movie` | 9.18+-9.32 | 9.07+-6.02 | 11.99+-6.08 |
| `select_max_timestamps_by_user` | 8.06+-6.65 | 7.78+-1.92 | 19.91+-26.86 |
| `select_movies_by_user` | 8.49+-8.80 | 11.47+-8.81 | 11.83+-4.81 |
| `select_users_by_movie` | 98.43+-40.43 | 93.88+-19.81 | 192.25+-46.38 |
| `insert_batch_1` | 5.56+-2.05 | 5.54+-1.86 | 12.51+-10.29 |
| `insert_batch_100` | 5.99+-1.76 | 6.46+-2.45 | 8.73+-4.54 |
| `insert_batch_1000` | 11.43+-2.16 | 12.95+-9.67 | 17.55+-8.20 |
